stages:
  - build
  - run
  - deploy

update config:
  stage: build
  tags:
    - shell
  script:
    - sudo cp -f nginx.conf ~/projectvictory-test/
    - sudo cp -f docker-compose.yaml ~/projectvictory-test/
  only:
    refs:
      - dev
    changes:
      - nginx.conf
      - docker-compose.yaml

build server:
  stage: build
  tags:
    - shell
  script:
    - sudo cp -r Backend/victory/. ~/projectvictory-test/backend
  after_script:
    - docker compose build backend
  only:
    refs:
      - dev
    changes:
      - Backend/victory/*

build web:
  stage: build
  tags:
    - shell
  script:
    - sudo cp -r Frontend/. ~/projectvictory-test/frontend
  after_script:
    - docker compose build frontend
  only:
    refs:
      - dev
    changes:
      - Frontend/*.vue

run server:
  stage: run
  tags:
    - shell
  before_script:
    - docker compose stop backend
  script:
    - docker compose up -d backend
  only:
    refs:
      - dev
    changes:
      - Backend/victory/*

run web:
  stage: run
  tags:
    - shell
  before_script:
    - docker compose stop frontend
  script:
    - docker compose up -d frontend
  only:
    refs:
      - dev
    changes:
      - Frontend/*.vue

run application:
  stage: run
  tags:
    - shell
  before_script:
    - cd ~/projectvictory-test
    - docker compose down -v
  script:
    - docker compose up -d
  only:
    refs:
      - dev
    changes:
      - nginx.conf
      - docker-compose.yaml

create application:
  stage: run
  tags:
    - shell
  before_script:
    - cd ~/projectvictory-test
  script:
    - docker compose up -d --build
  when: manual
